name: Add YAML file with variable replacement

on:
  workflow_dispatch:
    inputs:
      upstream_option:
        description: 'Choose an upstream option'
        required: true
        default: 'openai'
        type: choice
        options:
          - openai
          - gemini
          - claude
          - mistral

jobs:
  add_yaml_file:
    runs-on: ubuntu-latest

    env:
      HOSTNAME: 'ezai.kapoozi.com'
      NAMESPACE: 'argocd'
      APP_NAME: 'ezai-route'
      GATEWAY_NAMESPACE: 'gloo-system'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Generate random suffix
      id: suffix
      run: echo "::set-output name=suffix::$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 3)"

    - name: Set full application name
      run: echo "FULL_APP_NAME=${APP_NAME}-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 3)" >> $GITHUB_ENV

    - name: Create YAML file with placeholders
      run: |
        mkdir -p environments/kapoozi/ai-gateway-routes
        cat <<EOF > environments/kapoozi/ai-gateway-routes/application.yaml
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: ${{ env.FULL_APP_NAME }}
          namespace: ${NAMESPACE}
          finalizers:
            - resources-finalizer.argocd.argoproj.io
        spec:
          project: default
          destination:
            namespace: ai-gateway
            server: "https://kubernetes.default.svc"
          source:
            repoURL: 'https://github.com/ably77/llm-ly'
            targetRevision: HEAD
            path: llm-route-gen-chart
            helm:
              values: |
                metadata:
                  name: ezai-https
                  labels:
                    example: ${{ env.FULL_APP_NAME }}
                spec:
                  hostnames:
                    - "${HOSTNAME}"
                  parentRefs:
                    - name: https
                      namespace: ${GATEWAY_NAMESPACE}
                  rules:
                    - backendRefName: \${{ env.UPSTREAM_REF }}
                      pathPrefix: /\${{ env.UPSTREAM_REF }}
                      routeOptionName: \${{ env.ROUTE_OPTION }}
          syncPolicy:
            automated:
              prune: true
              selfHeal: true
        EOF

    - name: Set selected upstream variables
      run: |
        case ${{ github.event.inputs.upstream_option }} in
          "openai")
            echo "UPSTREAM_REF=openai" >> $GITHUB_ENV
            echo "ROUTE_OPTION=openai-route-policies" >> $GITHUB_ENV
            ;;
          "gemini")
            echo "UPSTREAM_REF=gemini" >> $GITHUB_ENV
            echo "ROUTE_OPTION=gemini-route-policies" >> $GITHUB_ENV
            ;;
          "claude")
            echo "UPSTREAM_REF=claude" >> $GITHUB_ENV
            echo "ROUTE_OPTION=claude-route-policies" >> $GITHUB_ENV
            ;;
          "mistral")
            echo "UPSTREAM_REF=mistral" >> $GITHUB_ENV
            echo "ROUTE_OPTION=mistral-route-policies" >> $GITHUB_ENV
            ;;
        esac

    - name: Replace variables in YAML file
      run: |
        envsubst < environments/kapoozi/ai-gateway-routes/application.yaml > environments/kapoozi/ai-gateway-routes/application.yaml.tmp
        mv environments/kapoozi/ai-gateway-routes/application.yaml.tmp environments/kapoozi/ai-gateway-routes/application.yaml

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add environments/kapoozi/ai-gateway-routes/application.yaml
        git commit -m "Add application.yaml file with replaced variables"
        git push https://github-actions:${{ secrets.PAT_TOKEN }}@github.com/ably77/llm-ly.git
