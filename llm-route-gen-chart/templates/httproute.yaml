{{- $name := .Values.metadata.name | default (printf "ezai-%s" (randAlphaNum 4 | lower)) }}
{{- $suffixStart := (len "ezai-") }}
{{- $randomSuffix := (printf "%s" (substr $name $suffixStart)) }}
{{- $generatedHostname := printf "%s.kapoozi.com" $randomSuffix }}
{{- $namespace := .Release.Namespace }}
{{- $hostnames := .Values.spec.hostnames | default (list $generatedHostname) }}
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: {{ $name }}
  namespace: {{ .Values.metadata.namespace | default $namespace }}
  labels:
{{- range $key, $value := .Values.metadata.labels }}
    {{ $key }}: {{ $value }}
{{- end }}
spec:
  hostnames:
{{- range $hostnames }}
    - {{ . }}
{{- end }}
  parentRefs:
{{- range .Values.spec.parentRefs }}
    - name: {{ .name | default "https" }}
      namespace: {{ .namespace | default "gloo-system" }}
{{- end }}
  rules:
{{- range .Values.spec.rules }}
    {{- $randomPath := printf "/%s/%s" $randomSuffix .backendRefName }}
    - backendRefs:
        - group: gloo.solo.io
          kind: Upstream
          name: {{ .backendRefName }}
      matches:
        - path:
            type: PathPrefix
            value: {{ if .useRandomPathPrefix }}{{ $randomPath }}{{ else }}{{ .pathPrefix }}{{ end }}
      filters:
        - type: ExtensionRef
          extensionRef:
            group: gateway.solo.io
            kind: RouteOption
            name: {{ .routeOptionName }}
{{- end }}
